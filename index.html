<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Superhuman">
<meta name="theme-color" content="#07070D">
<title>Superhuman</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07070D;--bg3:#161624;--card:#111120;--card2:#1A1A2E;
  --border:rgba(255,255,255,.07);--border2:rgba(255,255,255,.13);
  --text:#EEEEF5;--muted:rgba(238,238,245,.38);--muted2:rgba(238,238,245,.6);
  --fire:#FF5F1F;--teal:#00E5B0;--violet:#9B8AFF;--gold:#F6C90E;
  --red:#FF4D4D;--green:#2ECC71;
  --r:14px;
  --st:env(safe-area-inset-top);--sb:env(safe-area-inset-bottom);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);
  min-height:100vh;overflow-x:hidden;padding-bottom:calc(72px + var(--sb))}

.hdr{position:sticky;top:0;z-index:60;
  padding:calc(var(--st) + 14px) 16px 12px;
  background:linear-gradient(180deg,var(--bg) 70%,transparent);
  display:flex;align-items:center;justify-content:space-between;gap:10px}
.htitle{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:.06em;
  background:linear-gradient(135deg,#fff,rgba(238,238,245,.5));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdate{font-size:10px;color:var(--muted);margin-top:1px}
.sbtn{display:flex;align-items:center;gap:6px;flex-shrink:0;
  background:var(--card2);border:1px solid var(--border2);border-radius:20px;
  padding:8px 14px;font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;
  color:var(--muted2);cursor:pointer;-webkit-appearance:none;transition:all .2s}
.sbtn:active{transform:scale(.94)}
.sbtn.syn .si{animation:spin .7s linear infinite;display:inline-block}
.sbtn.ok{color:var(--teal);border-color:rgba(0,229,176,.3)}
.sbtn.err{color:var(--red);border-color:rgba(255,77,77,.3)}
@keyframes spin{to{transform:rotate(360deg)}}

.nav{position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:rgba(7,7,13,.96);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding:8px 0 calc(10px + var(--sb));
  display:grid;grid-template-columns:repeat(4,1fr)}
.nb{display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:5px 4px;border:none;background:none;
  font-family:'Outfit',sans-serif;font-size:9px;font-weight:700;
  letter-spacing:.07em;text-transform:uppercase;color:var(--muted);cursor:pointer}
.nb .ni{font-size:21px;line-height:1;transition:transform .2s}
.nb.active .ni{transform:scale(1.2) translateY(-1px)}
.nb[data-t=training].active{color:var(--fire)}
.nb[data-t=habits].active{color:var(--teal)}
.nb[data-t=mind].active{color:var(--violet)}
.nb[data-t=social].active{color:var(--gold)}

.screen{display:none;padding:2px 14px 20px;animation:rise .2s ease}
.screen.active{display:block}
@keyframes rise{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  padding:14px;margin-bottom:10px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.022),transparent 55%);pointer-events:none}
.ch{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.ct{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted)}
.bdg{font-family:'DM Mono',monospace;font-size:10px;padding:3px 9px;border-radius:6px}
.sl{font-size:9.5px;font-weight:700;letter-spacing:.13em;text-transform:uppercase;
  color:var(--muted);margin:16px 0 7px 2px}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.sc{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:13px 10px;text-align:center}
.sn{font-family:'Bebas Neue',sans-serif;font-size:40px;letter-spacing:.04em;line-height:1;margin-bottom:2px}
.sl2{font-size:9px;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--muted)}

.mgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.dlbl{text-align:center;font-size:9px;font-weight:700;color:var(--muted);padding-bottom:4px}
.mday{aspect-ratio:1;display:flex;align-items:center;justify-content:center;
  border-radius:8px;font-size:11px;font-weight:600;font-family:'DM Mono',monospace}
.mday.tr{background:var(--fire);color:#fff;cursor:pointer}
.mday.tr:active{transform:scale(.87)}
.mday.rs{background:var(--bg3);color:var(--muted)}
.mday.em{opacity:0}
.mday.td{box-shadow:0 0 0 2px var(--fire)}

.exrow{display:flex;align-items:center;justify-content:space-between;
  padding:10px 0;border-bottom:1px solid var(--border)}
.exrow:last-child{border-bottom:none}
.exn{font-size:13px;font-weight:600}
.exc{font-size:10px;color:var(--muted);margin-top:2px}
.exr{text-align:right}
.exkg{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--fire);line-height:1}
.exd{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace}

.pt{width:100%;border-collapse:collapse;font-size:11px}
.pt th{background:var(--bg3);padding:7px 5px;text-align:center;color:var(--muted);
  font-size:9px;letter-spacing:.07em;text-transform:uppercase}
.pt td{padding:9px 5px;text-align:center;border-bottom:1px solid var(--border);
  font-family:'DM Mono',monospace;font-size:11.5px}
.pt tr:last-child td{border-bottom:none}
.pt .ec{text-align:left;font-family:'Outfit',sans-serif;font-weight:700;font-size:12px}
.pt .hl{color:var(--teal)}

.hrow{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.hrow:last-child{border-bottom:none}
.hico{font-size:24px;width:30px;text-align:center;flex-shrink:0}
.hin{flex:1;min-width:0}
.hn{font-size:13px;font-weight:700;margin-bottom:3px}
.hm{font-size:10px;color:var(--muted)}
.hb{height:3px;background:var(--bg3);border-radius:2px;margin-top:6px;overflow:hidden}
.hbf{height:100%;border-radius:2px;transition:width .8s cubic-bezier(.34,1.56,.64,1)}
.hnum{font-family:'Bebas Neue',sans-serif;font-size:30px;letter-spacing:.04em;line-height:1;flex-shrink:0;text-align:right}
.hu{font-size:9px;color:var(--muted);text-align:right;margin-top:2px}

.cm{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.cml{text-align:center;font-size:9px;font-weight:700;color:var(--muted);padding-bottom:3px}
.cmd{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;
  font-size:9.5px;font-family:'DM Mono',monospace}
.cmd.t{background:var(--teal);color:var(--bg);font-weight:700}
.cmd.r{background:var(--bg3);color:var(--muted)}
.cmd.e{opacity:0}

.brow{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.brow:last-child{border-bottom:none}
.bcov{width:40px;height:55px;border-radius:6px;display:flex;align-items:center;
  justify-content:center;font-size:18px;flex-shrink:0}
.bin{flex:1;min-width:0}
.btn2{font-size:13px;font-weight:700;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bau{font-size:11px;color:var(--muted);margin-bottom:6px}
.bst{display:inline-block;font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px}
.brat{font-size:11px;margin-top:5px}

.trow{padding:12px 0;border-bottom:1px solid var(--border)}
.trow:last-child{border-bottom:none}
.tth{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:4px}
.tn{font-size:13px;font-weight:700}
.tp{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.04em}
.tm{font-size:10.5px;color:var(--muted);margin-bottom:7px}
.tb{height:4px;background:var(--bg3);border-radius:2px;overflow:hidden}
.tbf{height:100%;border-radius:2px}

.bdrow{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border)}
.bdrow:last-child{border-bottom:none}
.bdav{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:17px;flex-shrink:0}
.bdn{font-size:13px;font-weight:700;margin-bottom:2px}
.bdr{font-size:10px;color:var(--muted)}
.bdd{font-family:'Bebas Neue',sans-serif;font-size:19px;color:var(--gold);letter-spacing:.04em;line-height:1}

.crow{padding:12px 0;border-bottom:1px solid var(--border)}
.crow:last-child{border-bottom:none}
.crh{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.crav{width:32px;height:32px;border-radius:8px;background:var(--bg3);
  display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.crn{font-size:13px;font-weight:700}
.crr{font-size:10px;color:var(--muted)}
.tags{display:flex;flex-wrap:wrap;gap:5px}
.tag{font-size:10px;font-weight:600;padding:3px 8px;border-radius:6px;background:var(--bg3);color:var(--muted2)}

.exprow{display:flex;gap:11px;padding:11px 0;border-bottom:1px solid var(--border)}
.exprow:last-child{border-bottom:none}
.edot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:5px}
.eact{font-size:13px;font-weight:600;margin-bottom:3px}
.emet{font-size:10px;color:var(--muted)}
.enot{font-size:10px;color:var(--muted);font-style:italic;margin-top:4px}
.disc{font-size:11px;margin-top:4px}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.82);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  z-index:200;display:none;align-items:flex-end}
.overlay.open{display:flex}
.modal{background:var(--card2);border:1px solid var(--border2);
  border-radius:22px 22px 0 0;padding:16px 16px calc(20px + var(--sb));
  width:100%;max-height:80vh;overflow-y:auto;
  animation:sup .26s cubic-bezier(.32,.72,0,1)}
@keyframes sup{from{transform:translateY(100%)}to{transform:none}}
.mhan{width:34px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 16px}
.mtit{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:.04em;margin-bottom:3px}
.msub{font-size:11px;color:var(--muted);margin-bottom:16px}
.cbtn{float:right;border:none;background:var(--bg3);color:var(--muted);
  border-radius:8px;padding:7px 12px;font-family:'Outfit',sans-serif;
  font-size:11px;font-weight:700;cursor:pointer}

.notice{background:var(--bg3);border:1px solid var(--border2);border-radius:10px;
  padding:10px 12px;font-size:11px;color:var(--muted2);line-height:1.55;margin-bottom:12px}
.notice strong{color:var(--text)}

.empty{text-align:center;padding:24px 16px;font-size:12px;color:var(--muted);line-height:1.6}

.err-box{margin:20px 0;background:var(--bg3);border:1px solid rgba(255,77,77,.3);
  border-radius:12px;padding:16px;font-size:12px;color:var(--muted2);line-height:1.6}
.err-box strong{color:var(--red);display:block;margin-bottom:6px;font-size:13px}
</style>
</head>
<body>

<div class="overlay" id="modal">
  <div class="modal">
    <div class="mhan"></div>
    <button class="cbtn" onclick="document.getElementById('modal').classList.remove('open')">âœ• Cerrar</button>
    <div class="mtit" id="mDate"></div>
    <div class="msub" id="mSub"></div>
    <div id="mBody"></div>
  </div>
</div>

<header class="hdr">
  <div>
    <div class="htitle" id="hTitle">SUPERHUMAN</div>
    <div class="hdate" id="hDate"></div>
  </div>
  <button class="sbtn" id="sbtn" onclick="syncAll()">
    <span class="si">â†»</span><span id="slbl">Sincronizar</span>
  </button>
</header>

<section class="screen active" id="screen-training"><div id="tc"></div></section>
<section class="screen" id="screen-habits"><div id="hc"></div></section>
<section class="screen" id="screen-mind"><div id="mc"></div></section>
<section class="screen" id="screen-social"><div id="sc"></div></section>

<nav class="nav">
  <button class="nb active" data-t="training" onclick="go('training')"><span class="ni">ğŸ‹ï¸</span>Training</button>
  <button class="nb" data-t="habits" onclick="go('habits')"><span class="ni">ğŸŒ±</span>HÃ¡bitos</button>
  <button class="nb" data-t="mind" onclick="go('mind')"><span class="ni">ğŸ“š</span>Mente</button>
  <button class="nb" data-t="social" onclick="go('social')"><span class="ni">ğŸ¤</span>Social</button>
</nav>

<script>
/* â”€â”€ CONFIG â”€â”€ */
const SID  = '1TgUmsdPhe_iMqZSt3B11ZPg_LNmjo4SuiD0b1S4YZgA';
const GIDS = {training:'1240599111',habits:'1619760056',mind:'459953851',social:'1238337031'};
const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const WDAYS  = ['L','M','X','J','V','S','D'];

/* â”€â”€ CACHE â”€â”€ */
let D = {};
try { D = JSON.parse(localStorage.getItem('sh6')||'{}'); } catch(e){}
const save = () => { try{localStorage.setItem('sh6',JSON.stringify(D));}catch(e){} };

/* â”€â”€ CSV â”€â”€ */
function csv(text){
  return text.trim().split('\n').map(line=>{
    const out=[];let cur='',q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){q=!q;continue}
      if(c===','&&!q){out.push(cur.trim());cur='';continue}
      cur+=c;
    }
    out.push(cur.trim());
    return out;
  });
}

/* â”€â”€ FETCH â”€â”€ */
async function load(tab){
  const url=`https://docs.google.com/spreadsheets/d/${SID}/export?format=csv&gid=${GIDS[tab]}`;
  const r=await fetch(url,{cache:'no-cache'});
  if(!r.ok) throw new Error(`HTTP ${r.status} en hoja ${tab}`);
  const rows=csv(await r.text());
  D[tab]={rows,ts:Date.now()};
  save();
  return rows;
}

/* â”€â”€ SYNC â”€â”€ */
let busy=false;
async function syncAll(){
  if(busy)return;
  busy=true;
  const btn=document.getElementById('sbtn');
  btn.className='sbtn syn';
  document.getElementById('slbl').textContent='Cargandoâ€¦';

  const tabs=['training','habits','mind','social'];
  const errors=[];
  for(const t of tabs){
    try{ await load(t); }
    catch(e){ errors.push({tab:t,msg:e.message}); console.error(t,e); }
  }

  busy=false;
  if(errors.length===0){
    btn.className='sbtn ok';
    document.getElementById('slbl').textContent='âœ“ Listo';
  } else {
    btn.className='sbtn err';
    document.getElementById('slbl').textContent=errors.length+' error(es)';
  }
  setTimeout(()=>{btn.className='sbtn';document.getElementById('slbl').textContent='Sincronizar';},3000);

  renderAll(errors);
}

/* â”€â”€ NAV â”€â”€ */
const TITLES={training:'âš¡ TRAINING',habits:'ğŸŒ± HÃBITOS',mind:'ğŸ“š MENTE',social:'ğŸ¤ SOCIAL'};
function go(tab){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+tab).classList.add('active');
  document.querySelector('[data-t='+tab+']').classList.add('active');
  document.getElementById('hTitle').textContent=TITLES[tab];
  window.scrollTo(0,0);
}

/* â”€â”€ DATE UTILS â”€â”€ */
function pd(s){
  if(!s)return null;
  s=s.trim().replace(/\//g,'-');
  if(/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s.slice(0,10));
  if(/^\d{1,2}-\d{1,2}-\d{4}/.test(s)){const[a,b,c]=s.split('-');return new Date(`${c}-${b.padStart(2,'0')}-${a.padStart(2,'0')}`);}
  return null;
}
function days(s){const d=pd(s);if(!d||isNaN(d))return 0;return Math.max(0,Math.floor((Date.now()-d)/86400000));}
function fmtLong(s){const d=pd(s);if(!d)return s||'';return d.toLocaleDateString('es-CL',{weekday:'long',day:'numeric',month:'long'});}
function r25(v){return Math.round(v/2.5)*2.5;}
function woff(y,m){return((new Date(y,m,1).getDay())+6)%7;}
function dim(y,m){return new Date(y,m+1,0).getDate();}

/* â”€â”€ ERROR BOX â”€â”€ */
function errBox(msg){
  return `<div class="err-box"><strong>âš ï¸ Error de conexiÃ³n</strong>${msg}<br><br>
  AsegÃºrate que el Google Sheet sea pÃºblico (Compartir â†’ Cualquier persona con el enlace â†’ Ver)
  y pulsa <strong>Sincronizar</strong>.</div>`;
}

function noData(icon,msg){
  return `<div class="empty" style="padding:40px 16px"><div style="font-size:36px;margin-bottom:12px">${icon}</div>${msg}</div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRAINING
   Row 0: title banner
   Row 1: empty
   Row 2: headers (Fecha=col1, Ejercicio=col2, Categoria=col3, Series=col4, Reps=col5, Peso=col6)
   Rows 3+: data â€” stop when Fecha is empty AND col2 looks like section header
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTraining(errs){
  const el=document.getElementById('tc');
  if(errs){el.innerHTML=errBox(errs);return;}
  const raw=D.training?.rows||[];
  if(!raw.length){el.innerHTML=noData('ğŸ‹ï¸','Sin datos. Pulsa Sincronizar.');return;}

  /* parse sessions â€” start at row index 3, stop before projection table */
  const sessions=[];
  for(let i=3;i<raw.length;i++){
    const r=raw[i];
    const fecha=(r[1]||'').trim();
    const ejercicio=(r[2]||'').trim();
    if(!fecha||!ejercicio) continue;
    /* stop if we hit the projection section (col2 says "Ejercicio" again or col1 has projection text) */
    if(ejercicio.toLowerCase()==='ejercicio') break;
    if(fecha.toLowerCase().includes('proyecci')) break;
    const peso=parseFloat((r[6]||'0').replace(',','.').replace(/[^\d.]/g,''))||0;
    sessions.push({fecha,ejercicio,cat:(r[3]||'').trim(),series:(r[4]||'').trim(),reps:(r[5]||'').trim(),peso});
  }

  /* group by date */
  const byDate={};
  sessions.forEach(s=>{
    if(!byDate[s.fecha])byDate[s.fecha]=[];
    byDate[s.fecha].push(s);
  });
  window._byDate=byDate;

  /* trained days this month */
  const now=new Date(),yr=now.getFullYear(),mo=now.getMonth(),tod=now.getDate();
  const trained=new Set();
  Object.keys(byDate).forEach(f=>{const d=pd(f);if(d&&d.getFullYear()===yr&&d.getMonth()===mo)trained.add(d.getDate());});

  /* calendar */
  const off=woff(yr,mo),total=dim(yr,mo);
  let dlbls=WDAYS.map(d=>`<div class="dlbl">${d}</div>`).join('');
  let cells='';
  for(let i=0;i<off;i++) cells+=`<div class="mday em"></div>`;
  for(let d=1;d<=total;d++){
    const tr=trained.has(d),td=d===tod?'td':'';
    cells+=`<div class="mday ${tr?'tr':'rs'} ${td}" ${tr?`onclick="openSess(${d})"`:''}>${d}</div>`;
  }

  /* projection from projection table in sheet (rows 22-27 approximately) */
  /* Also build from actual session maxes as fallback */
  const BASICS=[{l:'Sentadilla',k:'sentadilla'},{l:'Peso Muerto',k:'peso muerto'},
    {l:'Press Banca',k:'press banca'},{l:'Press Militar',k:'press militar'},{l:'Remo',k:'remo'}];
  const maxW={};
  sessions.forEach(s=>{
    const ex=s.ejercicio.toLowerCase();
    BASICS.forEach(b=>{if(ex.includes(b.k)&&s.peso>0)maxW[b.l]=Math.max(maxW[b.l]||0,s.peso);});
  });
  /* also read from projection table rows (index ~21-26) */
  for(let i=21;i<Math.min(raw.length,28);i++){
    const r=raw[i];
    const ex=(r[1]||'').trim();
    const w=parseFloat((r[2]||'').replace(',','.').replace(/[^\d.]/g,''))||0;
    if(ex&&w>0) BASICS.forEach(b=>{if(ex.toLowerCase().includes(b.k.split(' ')[0]))maxW[b.l]=Math.max(maxW[b.l]||0,w);});
  }

  let projRows='';
  BASICS.forEach(b=>{
    if(!maxW[b.l])return;
    const c=maxW[b.l];
    projRows+=`<tr><td class="ec">${b.l}</td><td>${c}</td><td>${r25(c*1.025)}</td><td>${r25(c*Math.pow(1.025,3))}</td><td class="hl">${r25(c*Math.pow(1.025,12))}</td></tr>`;
  });

  el.innerHTML=`
    <div class="sl">${MONTHS[mo]} ${yr}</div>
    <div class="card">
      <div class="ch"><span class="ct">Sesiones del mes</span>
        <span class="bdg" style="background:rgba(255,95,31,.12);color:var(--fire)">${trained.size} dÃ­as entrenados</span>
      </div>
      <div class="mgrid">
        ${dlbls}
        <div style="grid-column:1/-1;display:grid;grid-template-columns:repeat(7,1fr);gap:3px">${cells}</div>
      </div>
    </div>
    ${sessions.length===0?noData('ğŸ‹ï¸','Agrega sesiones en la hoja Entrenamiento'):''}
    ${projRows?`<div class="sl">ProyecciÃ³n sobrecarga progresiva</div>
    <div class="card">
      <div class="ch"><span class="ct">+2.5% por semana</span>
        <span class="bdg" style="background:rgba(0,229,176,.1);color:var(--teal)">3 meses</span>
      </div>
      <table class="pt">
        <tr><th class="ec" style="text-align:left">Ejercicio</th><th>Actual</th><th>+2 sem</th><th>+4 sem</th><th>3 meses</th></tr>
        ${projRows}
      </table>
    </div>`:''}
    <div class="notice">ğŸ’¡ Toca un dÃ­a naranja para ver los ejercicios. Actualiza el Sheet â†’ <strong>Sincronizar</strong>.</div>`;
}

function openSess(day){
  const now=new Date(),yr=now.getFullYear(),mo=now.getMonth();
  const byDate=window._byDate||{};
  let found=null;
  Object.keys(byDate).forEach(f=>{const d=pd(f);if(d&&d.getFullYear()===yr&&d.getMonth()===mo&&d.getDate()===day)found=byDate[f];});
  if(!found)return;
  const maxKg=Math.max(...found.map(s=>s.peso));
  document.getElementById('mDate').textContent=fmtLong(found[0].fecha);
  document.getElementById('mSub').textContent=found.length+' ejercicios'+(maxKg>0?' Â· '+maxKg+' kg mÃ¡ximo':'');
  document.getElementById('mBody').innerHTML=found.map(s=>`
    <div class="exrow">
      <div><div class="exn">${s.ejercicio}</div><div class="exc">${s.cat}</div></div>
      <div class="exr"><div class="exkg">${s.peso>0?s.peso+' kg':'Peso Corp.'}</div><div class="exd">${s.series||'?'} Ã— ${s.reps||'?'}</div></div>
    </div>`).join('');
  document.getElementById('modal').classList.add('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HABITS
   Row 3: section header
   Row 4: col headers (B=HÃ¡bito, C=Fecha Inicio, D=DÃ­as Racha, E=Estado)  [index 3]
   Rows 4-11: habit data  [index 4-11]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const HEMOJI={alcohol:'ğŸº',golosina:'ğŸ¬',azucar:'ğŸ¥¤','azÃºcar':'ğŸ¥¤',energetica:'âš¡','energÃ©tica':'âš¡',ayuno:'â±',agua:'ğŸ’§','sueÃ±o':'ğŸ˜´',sueno:'ğŸ˜´',meditaci:'ğŸ§˜'};
const HCOLS=['var(--fire)','var(--teal)','var(--gold)','var(--violet)','#2ECC71','#00BFFF','#FF69B4','#FFA500'];
function hemoji(n){const l=n.toLowerCase();for(const[k,v]of Object.entries(HEMOJI))if(l.includes(k))return v;return 'ğŸ¯';}

function renderHabits(errs){
  const el=document.getElementById('hc');
  if(errs){el.innerHTML=errBox(errs);return;}
  const raw=D.habits?.rows||[];
  if(!raw.length){el.innerHTML=noData('ğŸŒ±','Sin datos. Pulsa Sincronizar.');return;}

  /* habits: index 4 to 11 (rows 5-12 in sheet), col B=index1, C=index2 */
  let habitHTML='';
  for(let i=4;i<=11&&i<raw.length;i++){
    const r=raw[i];
    const nombre=(r[1]||'').trim();
    if(!nombre)continue;
    const fecha=(r[2]||'').trim();
    const d=days(fecha);
    const pct=Math.min(100,(d/90)*100);
    const color=HCOLS[(i-4)%HCOLS.length];
    const medal=d>=90?'ğŸ†':d>=30?'ğŸ”¥':d>=14?'âœ…':d>=7?'ğŸŸ¡':'ğŸ”´';
    habitHTML+=`<div class="hrow">
      <div class="hico">${hemoji(nombre)}</div>
      <div class="hin">
        <div class="hn">${nombre}</div>
        <div class="hm">${fecha?'Desde '+fecha:'Sin fecha de inicio'}</div>
        <div class="hb"><div class="hbf" style="width:${pct}%;background:${color}"></div></div>
      </div>
      <div>
        <div class="hnum" style="color:${color}">${d}</div>
        <div class="hu">dÃ­as ${medal}</div>
      </div>
    </div>`;
  }

  /* training calendar */
  const now=new Date(),yr=now.getFullYear(),mo=now.getMonth();
  const trained=new Set();
  (D.training?.rows||[]).slice(3).forEach(r=>{const d=pd((r[1]||'').trim());if(d&&d.getFullYear()===yr&&d.getMonth()===mo)trained.add(d.getDate());});
  const off=woff(yr,mo),total=dim(yr,mo);
  const lbls=WDAYS.map(d=>`<div class="cml">${d}</div>`).join('');
  let cal='';
  for(let i=0;i<off;i++) cal+=`<div class="cmd e"></div>`;
  for(let d=1;d<=total;d++) cal+=`<div class="cmd ${trained.has(d)?'t':'r'}">${d}</div>`;

  el.innerHTML=`
    <div class="sl">Rachas activas</div>
    <div class="card">${habitHTML||noData('ğŸŒ±','Agrega hÃ¡bitos en el Google Sheet')}</div>
    <div class="sl">Calendario de entrenamiento â€” ${MONTHS[mo]}</div>
    <div class="card">
      <div class="ch"><span class="ct">${MONTHS[mo]} ${yr}</span>
        <span class="bdg" style="background:rgba(0,229,176,.1);color:var(--teal)">${trained.size} dÃ­as âœ…</span>
      </div>
      <div class="cm">
        ${lbls}
        <div style="grid-column:1/-1;display:grid;grid-template-columns:repeat(7,1fr);gap:3px">${cal}</div>
      </div>
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MIND
   Row 2: "LIBROS" header
   Row 3: col headers (B=TÃ­tulo,C=Autor,D=Inicio,E=Fin,F=Estado,G=CategorÃ­a,H=Rating) [index 3]
   Rows 4-8: books [index 4-8]
   Row 9: Total LeÃ­dos [index 9] â€” skip
   Row 10: empty [index 10]
   Row 11: "TEMAS EN APRENDIZAJE" [index 11]
   Row 12: col headers (B=Tema,C=Fuente,D=Formato,E=Inicio,F=%Avance,G=Horas,H=Notas) [index 12]
   Rows 13-17: topics [index 13-17]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BCOLS=[['rgba(155,138,255,.2)','var(--violet)'],['rgba(0,229,176,.15)','var(--teal)'],
  ['rgba(255,95,31,.15)','var(--fire)'],['rgba(246,201,14,.15)','var(--gold)']];
const TCOLS=['var(--teal)','var(--fire)','var(--violet)','var(--gold)'];

function renderMind(errs){
  const el=document.getElementById('mc');
  if(errs){el.innerHTML=errBox(errs);return;}
  const raw=D.mind?.rows||[];
  if(!raw.length){el.innerHTML=noData('ğŸ“š','Sin datos. Pulsa Sincronizar.');return;}

  /* books: index 4 to 8 */
  let bookHTML='',read=0;
  for(let i=4;i<=8&&i<raw.length;i++){
    const r=raw[i];
    const titulo=(r[1]||'').trim();
    if(!titulo)continue;
    const autor=(r[2]||'').trim();
    const estado=(r[5]||'').trim();
    const cat=(r[6]||'').trim();
    const rating=parseInt(r[7])||0;
    const done=estado.includes('âœ…')||estado.toLowerCase().includes('le');
    const reading=estado.includes('ğŸ“–')||estado.toLowerCase().includes('leyendo');
    if(done)read++;
    const sc=done?'rgba(46,204,113,.2)':reading?'rgba(246,201,14,.2)':'rgba(120,120,120,.15)';
    const st=done?'#2ECC71':reading?'#F6C90E':'var(--muted)';
    const [bg,fg]=BCOLS[(i-4)%4];
    const stars=rating>0?'â­'.repeat(Math.min(rating,5)):'';
    bookHTML+=`<div class="brow">
      <div class="bcov" style="background:${bg};color:${fg}">ğŸ“—</div>
      <div class="bin">
        <div class="btn2">${titulo}</div>
        <div class="bau">${[autor,cat].filter(Boolean).join(' Â· ')||'â€”'}</div>
        <span class="bst" style="background:${sc};color:${st}">${estado||'â€”'}</span>
        ${stars?`<div class="brat">${stars}</div>`:''}
      </div>
    </div>`;
  }

  /* topics: index 13 to 17 */
  let topicHTML='';
  for(let i=13;i<=17&&i<raw.length;i++){
    const r=raw[i];
    const tema=(r[1]||'').trim();
    if(!tema)continue;
    const fuente=(r[2]||'').trim();
    const formato=(r[3]||'').trim();
    const avanceRaw=(r[5]||'').replace('%','').trim();
    const avance=avanceRaw.toLowerCase()==='continuo'?100:parseInt(avanceRaw)||0;
    const avanceLbl=avanceRaw.toLowerCase()==='continuo'?'âˆ%':avance+'%';
    const horas=parseInt(r[6])||0;
    const c=TCOLS[(i-13)%4];
    topicHTML+=`<div class="trow">
      <div class="tth"><div class="tn">${tema}</div><div class="tp" style="color:${c}">${avanceLbl}</div></div>
      <div class="tm">${[fuente,formato,horas?horas+'h':''].filter(Boolean).join(' Â· ')}</div>
      <div class="tb"><div class="tbf" style="width:${Math.min(avance,100)}%;background:${c}"></div></div>
    </div>`;
  }

  el.innerHTML=`
    <div class="sg">
      <div class="sc"><div class="sn" style="color:var(--violet)">${read}</div><div class="sl2">Libros leÃ­dos</div></div>
      <div class="sc"><div class="sn" style="color:var(--teal)">${topicHTML?raw.slice(13,18).filter(r=>r[1]?.trim()).length:0}</div><div class="sl2">Temas activos</div></div>
    </div>
    <div class="sl">Biblioteca</div>
    <div class="card">${bookHTML||noData('ğŸ“š','Agrega libros en la hoja Intelectual')}</div>
    ${topicHTML?`<div class="sl">Aprendizaje activo</div><div class="card">${topicHTML}</div>`:''}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOCIAL
   From screenshots:
   CumpleaÃ±os: rows ~4-8 (index 3-7) col B=Nombre,C=RelaciÃ³n,D=Fecha,E=Regalo
   Red Contactos header row index ~11, data index 13-17: B=Nombre,C=ProfesiÃ³n,D=CÃ³mo,E=Fecha,F=Intereses,G=ÃšltimoContacto,H=AcciÃ³n
   ExposiciÃ³n header index ~21, data index 22+: B=Fecha,C=Actividad,D=Personas,E=Incomodidad,F=Logro,G=ReflexiÃ³n
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BDCOLORS=['rgba(246,201,14,.18)','rgba(255,95,31,.15)','rgba(155,138,255,.15)','rgba(0,229,176,.12)'];
const CREMOJIS=['ğŸ‘¤','ğŸ§‘â€ğŸ’¼','ğŸ‘©â€ğŸ’»','ğŸ‘¨â€ğŸ¨','ğŸ§‘â€ğŸ”¬','ğŸ‘©â€ğŸ«','ğŸ§‘â€ğŸš€','ğŸ‘¨â€ğŸ³'];

function renderSocial(errs){
  const el=document.getElementById('sc');
  if(errs){el.innerHTML=errBox(errs);return;}
  const raw=D.social?.rows||[];
  if(!raw.length){el.innerHTML=noData('ğŸ¤','Sin datos. Pulsa Sincronizar.');return;}

  /* birthdays: index 3 to 7 */
  let bdHTML='',bdCount=0;
  for(let i=3;i<=7&&i<raw.length;i++){
    const r=raw[i];
    const nombre=(r[1]||'').trim();
    if(!nombre||nombre.toLowerCase()==='nombre')continue;
    const fecha=(r[3]||'').trim();
    if(fecha==='DD/MM'||!fecha)continue; // skip placeholder rows
    bdCount++;
    bdHTML+=`<div class="bdrow">
      <div class="bdav" style="background:${BDCOLORS[(bdCount-1)%4]}">ğŸ‚</div>
      <div style="flex:1">
        <div class="bdn">${nombre}</div>
        <div class="bdr">${(r[2]||'').trim()||'â€”'}</div>
        ${r[4]?`<div style="font-size:10px;color:var(--muted);margin-top:2px">ğŸ ${r[4].trim()}</div>`:''}
      </div>
      <div><div class="bdd">${fecha}</div></div>
    </div>`;
  }

  /* contacts: index 13 to 17 */
  let ctHTML='',ctCount=0;
  for(let i=13;i<=17&&i<raw.length;i++){
    const r=raw[i];
    const nombre=(r[1]||'').trim();
    if(!nombre)continue;
    ctCount++;
    const rol=(r[2]||'').trim(),como=(r[3]||'').trim(),inter=(r[5]||'').trim(),accion=(r[7]||'').trim();
    ctHTML+=`<div class="crow">
      <div class="crh">
        <div class="crav">${CREMOJIS[(ctCount-1)%8]}</div>
        <div><div class="crn">${nombre}</div><div class="crr">${rol||'â€”'}</div></div>
      </div>
      <div class="tags">
        ${como?`<span class="tag">ğŸ“ ${como}</span>`:''}
        ${inter?`<span class="tag">ğŸ’¡ ${inter}</span>`:''}
        ${accion?`<span class="tag">â†’ ${accion}</span>`:''}
      </div>
    </div>`;
  }

  /* exposures: index 22+ */
  let expHTML='',expCount=0;
  for(let i=22;i<raw.length;i++){
    const r=raw[i];
    const act=(r[2]||'').trim();
    if(!act)continue;
    expCount++;
    const disc=parseInt(r[4])||1;
    const cc=disc>=4?'var(--fire)':disc>=3?'var(--gold)':'var(--teal)';
    const nota=(r[6]||'').trim();
    expHTML+=`<div class="exprow">
      <div class="edot" style="background:${cc}"></div>
      <div>
        <div class="eact">${act}</div>
        <div class="emet">${[(r[1]||'').trim(),(r[3]||'').trim()].filter(Boolean).join(' Â· ')}</div>
        <div class="disc">${'ğŸ”¥'.repeat(disc)}${'â¬›'.repeat(5-disc)}</div>
        ${nota?`<div class="enot">"${nota}"</div>`:''}
      </div>
    </div>`;
  }
  /* exposures newest first */
  if(expHTML){
    const div=document.createElement('div');
    div.innerHTML=expHTML;
    const rows=[...div.children];
    expHTML=rows.reverse().map(r=>r.outerHTML).join('');
  }

  el.innerHTML=`
    <div class="sg">
      <div class="sc"><div class="sn" style="color:var(--gold)">${ctCount}</div><div class="sl2">Contactos</div></div>
      <div class="sc"><div class="sn" style="color:var(--fire)">${expCount}</div><div class="sl2">Exposiciones</div></div>
    </div>
    ${bdHTML?`<div class="sl">CumpleaÃ±os</div><div class="card">${bdHTML}</div>`:''}
    <div class="sl">Red de contactos</div>
    <div class="card">${ctHTML||noData('ğŸ‘¥','Agrega contactos en la hoja Social')}</div>
    <div class="sl">ExposiciÃ³n social</div>
    <div class="card">${expHTML||noData('ğŸ—£ï¸','Registra interacciones en la hoja Social')}</div>`;
}

/* â”€â”€ RENDER ALL â”€â”€ */
function renderAll(errors){
  const e=errors||[];
  const err=tab=>e.find(x=>x.tab===tab)?.msg||null;
  try{renderTraining(err('training'));}catch(ex){document.getElementById('tc').innerHTML=errBox(ex.message);}
  try{renderHabits(err('habits'));}catch(ex){document.getElementById('hc').innerHTML=errBox(ex.message);}
  try{renderMind(err('mind'));}catch(ex){document.getElementById('mc').innerHTML=errBox(ex.message);}
  try{renderSocial(err('social'));}catch(ex){document.getElementById('sc').innerHTML=errBox(ex.message);}
}

/* â”€â”€ INIT â”€â”€ */
document.getElementById('hDate').textContent =
  new Date().toLocaleDateString('es-CL',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).toUpperCase();

document.getElementById('modal').addEventListener('click',function(e){
  if(e.target===this)this.classList.remove('open');
});

/* Render cache instantly, then sync */
renderAll([]);
syncAll();
</script>
</body>
</html>
