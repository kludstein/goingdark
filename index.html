<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Superhuman">
<meta name="theme-color" content="#07070D">
<title>âš¡ Superhuman</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#07070D; --bg2:#0E0E18; --bg3:#161624;
  --card:#111120; --card2:#1A1A2E;
  --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.13);
  --text:#EEEEF5; --muted:rgba(238,238,245,0.38); --muted2:rgba(238,238,245,0.6);
  --fire:#FF5F1F; --teal:#00E5B0; --violet:#9B8AFF; --gold:#F6C90E;
  --red:#FF4D4D; --green:#2ECC71;
  --r:14px;
  --safe-top:env(safe-area-inset-top); --safe-bot:env(safe-area-inset-bottom);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{height:-webkit-fill-available}
body{
  font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);
  min-height:100vh;min-height:-webkit-fill-available;
  overflow-x:hidden;padding-bottom:calc(72px + var(--safe-bot));
}

/* HEADER */
.header{
  position:sticky;top:0;z-index:60;
  padding:calc(var(--safe-top) + 14px) 18px 14px;
  background:linear-gradient(180deg,var(--bg) 75%,transparent);
  display:flex;align-items:center;justify-content:space-between;gap:12px;
}
.htitle{
  font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:.06em;
  background:linear-gradient(135deg,#fff 0%,rgba(238,238,245,.55) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.hdate{font-size:10.5px;color:var(--muted);font-weight:500;letter-spacing:.04em;margin-top:1px}
.sync-btn{
  display:flex;align-items:center;gap:6px;flex-shrink:0;
  background:var(--card2);border:1px solid var(--border2);border-radius:20px;
  padding:8px 14px;font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;
  color:var(--muted2);cursor:pointer;transition:all .2s;-webkit-appearance:none;
}
.sync-btn:active{transform:scale(.94)}
.sync-btn.syncing .si{animation:spin .7s linear infinite;display:inline-block}
.sync-btn.ok{color:var(--teal);border-color:rgba(0,229,176,.3)}
.sync-btn.err{color:var(--red);border-color:rgba(255,77,77,.3)}
@keyframes spin{to{transform:rotate(360deg)}}

/* NAV */
.nav{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:rgba(7,7,13,.95);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding:8px 0 calc(10px + var(--safe-bot));
  display:grid;grid-template-columns:repeat(4,1fr);
}
.nb{
  display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:5px 4px;border:none;background:none;
  font-family:'Outfit',sans-serif;font-size:9px;font-weight:700;
  letter-spacing:.07em;text-transform:uppercase;color:var(--muted);cursor:pointer;
}
.nb .ni{font-size:21px;line-height:1;transition:transform .2s}
.nb.active .ni{transform:scale(1.2) translateY(-1px)}
.nb[data-t=training].active{color:var(--fire)}
.nb[data-t=habits].active{color:var(--teal)}
.nb[data-t=mind].active{color:var(--violet)}
.nb[data-t=social].active{color:var(--gold)}

/* SCREENS */
.screen{display:none;padding:2px 14px 20px;animation:rise .2s ease}
.screen.active{display:block}
@keyframes rise{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* STATES */
.state-box{margin:50px auto;max-width:260px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:12px}
.spinner{width:34px;height:34px;border:3px solid var(--border2);border-top-color:var(--fire);border-radius:50%;animation:spin .75s linear infinite}
.state-title{font-size:15px;font-weight:700}
.state-sub{font-size:12.5px;color:var(--muted);line-height:1.6}

/* SECTION */
.slabel{font-size:9.5px;font-weight:700;letter-spacing:.13em;text-transform:uppercase;color:var(--muted);margin:16px 0 7px 2px}

/* CARD */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:10px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.022) 0%,transparent 55%);pointer-events:none}
.ch{display:flex;align-items:center;justify-content:space-between;margin-bottom:13px}
.ct{font-size:10.5px;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--muted)}
.badge{font-family:'DM Mono',monospace;font-size:10px;padding:3px 9px;border-radius:6px}

/* STAT GRID */
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.scell{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:14px 10px;text-align:center}
.snum{font-family:'Bebas Neue',sans-serif;font-size:40px;letter-spacing:.04em;line-height:1;margin-bottom:2px}
.slbl2{font-size:9px;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--muted)}

/* MONTH CALENDAR */
.mgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.dlbl{text-align:center;font-size:9px;font-weight:700;color:var(--muted);letter-spacing:.04em;padding-bottom:4px}
.mday{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:8px;font-size:11px;font-weight:600;font-family:'DM Mono',monospace;transition:transform .12s;cursor:default}
.mday.trained{background:var(--fire);color:#fff;cursor:pointer}
.mday.rest{background:var(--bg3);color:var(--muted)}
.mday.empty{opacity:0}
.mday.today{box-shadow:0 0 0 2px var(--fire)}
.mday.trained:active{transform:scale(.87)}

/* EXERCISE ROWS */
.exrow{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
.exrow:last-child{border-bottom:none}
.exname{font-size:13.5px;font-weight:600}
.excat{font-size:10.5px;color:var(--muted);margin-top:2px}
.exr{text-align:right}
.exkg{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:.04em;color:var(--fire);line-height:1}
.exdet{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:1px}

/* PROJECTION TABLE */
.ptable{width:100%;border-collapse:collapse;font-size:11px}
.ptable th{background:var(--bg3);padding:7px 5px;text-align:center;color:var(--muted);font-size:9px;letter-spacing:.07em;text-transform:uppercase}
.ptable td{padding:9px 5px;text-align:center;border-bottom:1px solid var(--border);font-family:'DM Mono',monospace;font-size:11.5px}
.ptable tr:last-child td{border-bottom:none}
.ptable .ecol{text-align:left;font-family:'Outfit',sans-serif;font-weight:700;font-size:12px}
.ptable .hl{color:var(--teal);font-weight:500}

/* HABIT ROWS */
.hrow{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.hrow:last-child{border-bottom:none}
.hico{font-size:24px;flex-shrink:0;width:32px;text-align:center}
.hinfo{flex:1;min-width:0}
.hname{font-size:13.5px;font-weight:600;margin-bottom:3px}
.hmeta{font-size:10px;color:var(--muted)}
.hbar{height:3px;background:var(--bg3);border-radius:2px;margin-top:6px;overflow:hidden}
.hbar-fill{height:100%;border-radius:2px;transition:width .8s cubic-bezier(.34,1.56,.64,1)}
.hnum{font-family:'Bebas Neue',sans-serif;font-size:30px;letter-spacing:.04em;line-height:1;flex-shrink:0;text-align:right}
.hunit{font-size:9px;color:var(--muted);text-align:right;letter-spacing:.03em;margin-top:2px}

/* CAL MINI */
.cmini{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.cmlbl{text-align:center;font-size:9px;font-weight:700;color:var(--muted);padding-bottom:3px}
.cmday{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:9.5px;font-family:'DM Mono',monospace}
.cmday.t{background:var(--teal);color:var(--bg);font-weight:700}
.cmday.r{background:var(--bg3);color:var(--muted)}
.cmday.e{opacity:0}

/* BOOKS */
.brow{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.brow:last-child{border-bottom:none}
.bcover{width:40px;height:55px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.binfo{flex:1;min-width:0}
.btitle{font-size:13.5px;font-weight:700;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bauthor{font-size:11px;color:var(--muted);margin-bottom:6px}
.bstatus{display:inline-block;font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;letter-spacing:.03em}
.brating{font-size:11px;margin-top:5px}

/* TOPICS */
.trow{padding:12px 0;border-bottom:1px solid var(--border)}
.trow:last-child{border-bottom:none}
.tth{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:4px}
.tname{font-size:13.5px;font-weight:700}
.tpct{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:.04em}
.tmeta{font-size:10.5px;color:var(--muted);margin-bottom:7px}
.tbar{height:4px;background:var(--bg3);border-radius:2px;overflow:hidden}
.tbar-fill{height:100%;border-radius:2px}

/* BIRTHDAY ROWS */
.bdrow{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border)}
.bdrow:last-child{border-bottom:none}
.bdav{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.bdname{font-size:13.5px;font-weight:700;margin-bottom:2px}
.bdrel{font-size:10.5px;color:var(--muted)}
.bddate{font-family:'Bebas Neue',sans-serif;font-size:19px;color:var(--gold);letter-spacing:.04em;line-height:1}
.bdgift{font-size:10px;color:var(--muted);text-align:right;margin-top:2px}

/* CONTACT ROWS */
.crow{padding:12px 0;border-bottom:1px solid var(--border)}
.crow:last-child{border-bottom:none}
.crh{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.crav{width:32px;height:32px;border-radius:8px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.crname{font-size:13.5px;font-weight:700}
.crrole{font-size:10.5px;color:var(--muted)}
.tags{display:flex;flex-wrap:wrap;gap:5px}
.tag{font-size:10px;font-weight:600;padding:3px 8px;border-radius:6px;background:var(--bg3);color:var(--muted2)}

/* EXPOSURE ROWS */
.exprow{display:flex;gap:11px;padding:11px 0;border-bottom:1px solid var(--border)}
.exprow:last-child{border-bottom:none}
.expdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:5px}
.expact{font-size:13.5px;font-weight:600;margin-bottom:3px}
.expmeta{font-size:10.5px;color:var(--muted)}
.expnote{font-size:10.5px;color:var(--muted);font-style:italic;margin-top:4px;line-height:1.4}
.disc{font-size:11px;margin-top:4px;letter-spacing:1px}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:200;display:none;align-items:flex-end}
.overlay.open{display:flex}
.modal{background:var(--card2);border:1px solid var(--border2);border-radius:22px 22px 0 0;padding:16px 16px calc(20px + var(--safe-bot));width:100%;max-height:80vh;overflow-y:auto;animation:slideup .26s cubic-bezier(.32,.72,0,1)}
@keyframes slideup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhandle{width:34px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 16px}
.mtitle{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:.04em;margin-bottom:3px}
.msub{font-size:11.5px;color:var(--muted);margin-bottom:16px}
.closebtn{float:right;border:none;background:var(--bg3);color:var(--muted);border-radius:8px;padding:7px 12px;font-family:'Outfit',sans-serif;font-size:11.5px;font-weight:700;cursor:pointer}

/* NOTICE */
.notice{background:var(--bg3);border:1px solid var(--border2);border-radius:10px;padding:10px 12px;font-size:11.5px;color:var(--muted2);line-height:1.55;margin-bottom:12px}
.notice strong{color:var(--text)}

/* EMPTY */
.empty{text-align:center;padding:24px 16px;font-size:12.5px;color:var(--muted);line-height:1.6}
</style>
</head>
<body>

<!-- SESSION MODAL -->
<div class="overlay" id="sessionModal">
  <div class="modal">
    <div class="mhandle"></div>
    <button class="closebtn" onclick="document.getElementById('sessionModal').classList.remove('open')">âœ• Cerrar</button>
    <div class="mtitle" id="mDate"></div>
    <div class="msub" id="mSub"></div>
    <div id="mContent"></div>
  </div>
</div>

<!-- HEADER -->
<header class="header">
  <div>
    <div class="htitle" id="hTitle">âš¡ SUPERHUMAN</div>
    <div class="hdate" id="hDate"></div>
  </div>
  <button class="sync-btn" id="syncBtn" onclick="syncAll()">
    <span class="si">â†»</span>
    <span id="syncLabel">Sincronizar</span>
  </button>
</header>

<!-- SCREENS -->
<section class="screen active" id="screen-training">
  <div id="t-content"><div class="state-box"><div class="spinner"></div><div class="state-title">Cargandoâ€¦</div></div></div>
</section>
<section class="screen" id="screen-habits">
  <div id="h-content"><div class="state-box"><div class="spinner"></div><div class="state-title">Cargandoâ€¦</div></div></div>
</section>
<section class="screen" id="screen-mind">
  <div id="m-content"><div class="state-box"><div class="spinner"></div><div class="state-title">Cargandoâ€¦</div></div></div>
</section>
<section class="screen" id="screen-social">
  <div id="s-content"><div class="state-box"><div class="spinner"></div><div class="state-title">Cargandoâ€¦</div></div></div>
</section>

<!-- NAV -->
<nav class="nav">
  <button class="nb active" data-t="training" onclick="go('training')"><span class="ni">ğŸ‹ï¸</span>Training</button>
  <button class="nb" data-t="habits" onclick="go('habits')"><span class="ni">ğŸŒ±</span>HÃ¡bitos</button>
  <button class="nb" data-t="mind" onclick="go('mind')"><span class="ni">ğŸ“š</span>Mente</button>
  <button class="nb" data-t="social" onclick="go('social')"><span class="ni">ğŸ¤</span>Social</button>
</nav>

<script>
'use strict';

/* â”€â”€â”€ SHEET CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SID = '1TgUmsdPhe_iMqZSt3B11ZPg_LNmjo4SuiD0b1S4YZgA';
const GIDS = { training:'1240599111', habits:'1619760056', mind:'459953851', social:'1238337031' };
const CSV  = gid => `https://docs.google.com/spreadsheets/d/${SID}/export?format=csv&gid=${gid}`;

/* â”€â”€â”€ CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const CK = 'sh_v5';
let C = {};
try { C = JSON.parse(localStorage.getItem(CK)||'{}'); } catch(e){}
const save = () => { try { localStorage.setItem(CK, JSON.stringify(C)); } catch(e){} };

/* â”€â”€â”€ CSV PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Returns array of arrays (raw rows, no header mapping).
   Caller decides which row is header and which rows are data.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function parseCSV(text) {
  return text.trim().split('\n').map(line => {
    const cells = []; let cur = '', inQ = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') { inQ = !inQ; continue; }
      if (ch === ',' && !inQ) { cells.push(cur.trim()); cur = ''; continue; }
      cur += ch;
    }
    cells.push(cur.trim());
    return cells;
  });
}

/* Strip emojis and extra whitespace for comparison */
function clean(s) {
  return (s||'').replace(/[\u{1F000}-\u{1FFFF}\u{2600}-\u{27FF}\u{2300}-\u{23FF}âœ…âŒğŸ“–ğŸ“‹ğŸ”¥ğŸŒ±ğŸ“šğŸ¤ğŸ‹ï¸âš¡ğŸ‚ğŸ‘¥ğŸ¯ğŸ’§ğŸ˜´ğŸ§˜ğŸš«]/gu,'').trim().toLowerCase();
}

/* â”€â”€â”€ FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchRaw(tab) {
  const res = await fetch(CSV(GIDS[tab]), {cache:'no-cache'});
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const rows = parseCSV(await res.text());
  C[tab] = { rows, ts: Date.now() };
  save();
  return rows;
}

/* â”€â”€â”€ SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let busy = false;
async function syncAll() {
  if (busy) return;
  busy = true;
  const btn = document.getElementById('syncBtn');
  btn.className = 'sync-btn syncing';
  document.getElementById('syncLabel').textContent = 'Cargandoâ€¦';
  let errs = 0;
  const results = await Promise.allSettled(['training','habits','mind','social'].map(t =>
    fetchRaw(t)
  ));
  results.forEach((r,i) => {
    if (r.status === 'rejected') {
      errs++;
      console.error(['training','habits','mind','social'][i], r.reason);
    }
  });
  busy = false;
  btn.className = errs ? 'sync-btn err' : 'sync-btn ok';
  document.getElementById('syncLabel').textContent = errs ? `${errs} error(es)` : 'âœ“ Listo';
  setTimeout(() => { btn.className='sync-btn'; document.getElementById('syncLabel').textContent='Sincronizar'; }, 2800);
  try { renderAll(); } catch(e) { console.error('renderAll error:', e); showGlobalError(e); }
}

function showGlobalError(e) {
  document.querySelectorAll('.screen.active [id$="-content"]').forEach(el => {
    el.innerHTML = `<div class="state-box">
      <div style="font-size:32px">âš ï¸</div>
      <div class="state-title">Error al procesar datos</div>
      <div class="state-sub" style="font-size:11px;text-align:left;background:var(--bg3);padding:10px;border-radius:8px;margin-top:4px">${e.message}</div>
    </div>`;
  });
}

/* â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const TITLES = { training:'âš¡ TRAINING', habits:'ğŸŒ± HÃBITOS', mind:'ğŸ“š MENTE', social:'ğŸ¤ SOCIAL' };
function go(tab) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nb').forEach(b => b.classList.remove('active'));
  document.getElementById(`screen-${tab}`).classList.add('active');
  document.querySelector(`[data-t=${tab}]`).classList.add('active');
  document.getElementById('hTitle').textContent = TITLES[tab];
  window.scrollTo(0,0);
}

/* â”€â”€â”€ DATE UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function parseDate(s) {
  if (!s) return null;
  s = s.trim().replace(/\//g,'-');
  // YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s.slice(0,10));
  // DD-MM-YYYY
  if (/^\d{2}-\d{2}-\d{4}/.test(s)) { const [d,m,y]=s.split('-'); return new Date(`${y}-${m}-${d}`); }
  return null;
}
function calcDays(s) {
  const d = parseDate(s);
  if (!d || isNaN(d)) return 0;
  return Math.max(0, Math.floor((Date.now()-d)/86400000));
}
function fmtFull(s) {
  const d = parseDate(s);
  if (!d) return s||'';
  return d.toLocaleDateString('es-CL',{weekday:'long',day:'numeric',month:'long'});
}
function round25(v) { return Math.round(v/2.5)*2.5; }

const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DAYS7  = ['L','M','X','J','V','S','D'];
function weekOffset(y,m) { return ((new Date(y,m,1).getDay())+6)%7; }
function daysInMonth(y,m) { return new Date(y,m+1,0).getDate(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRAINING
   Sheet structure:
     Row 1: Title banner
     Row 2: Empty
     Row 3: Headers â†’ Col B=Fecha, C=Ejercicio, D=CategorÃ­a, E=Series, F=Reps, G=Peso(kg), H=Notas, I=PrÃ³x.SesiÃ³n, J=%Progreso
     Rows 4+: Data (until empty row ~20)
     Row 21+: Projection table (SKIP)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseTraining(rawRows) {
  // rawRows is 0-indexed. Row 3 (index 2) = headers, data from index 3
  // Stop when we hit a row where col B is empty AND col C starts looking like a section header
  const sessions = [];
  for (let i = 3; i < rawRows.length; i++) {
    const row = rawRows[i];
    const fecha = row[1]; // col B (0=A,1=B,2=C...)
    const ejercicio = row[2]; // col C
    if (!fecha || !ejercicio) continue;
    // Stop if this looks like the projection section header
    if (clean(ejercicio).includes('proyecci') || clean(fecha).includes('proyecci')) break;
    if (clean(ejercicio).includes('ejercicio') && i > 10) break; // repeated header
    sessions.push({
      fecha:    fecha,
      ejercicio: ejercicio,
      categoria: row[3]||'',
      series:    row[4]||'',
      reps:      row[5]||'',
      peso:      parseFloat((row[6]||'0').replace(',','.')) || 0,
      notas:     row[7]||'',
    });
  }
  return sessions;
}

function renderTraining() {
  const el   = document.getElementById('t-content');
  const raw  = C.training?.rows || [];

  if (!raw.length) {
    el.innerHTML = `<div class="state-box"><div class="spinner"></div><div class="state-title">Sin datos</div><div class="state-sub">Pulsa Sincronizar</div></div>`;
    return;
  }

  const sessions = parseTraining(raw);

  if (!sessions.length) {
    el.innerHTML = `<div class="state-box"><div class="state-icon">ğŸ‹ï¸</div><div class="state-title">Sin sesiones aÃºn</div><div class="state-sub">Agrega sesiones en la hoja Entrenamiento del Google Sheet y pulsa Sincronizar.</div></div>`;
    return;
  }

  // Group by date string
  const byDate = {};
  sessions.forEach(s => {
    if (!byDate[s.fecha]) byDate[s.fecha] = [];
    byDate[s.fecha].push(s);
  });
  window._sessions = byDate;

  // Trained days this month
  const now = new Date(), yr = now.getFullYear(), mo = now.getMonth(), tod = now.getDate();
  const trainedDays = new Set();
  Object.keys(byDate).forEach(f => {
    const d = parseDate(f);
    if (d && d.getFullYear()===yr && d.getMonth()===mo) trainedDays.add(d.getDate());
  });

  // Calendar
  const off = weekOffset(yr,mo), dim = daysInMonth(yr,mo);
  let cells = DAYS7.map(d=>`<div class="dlbl">${d}</div>`).join('');
  let inner = '';
  for(let i=0;i<off;i++) inner+=`<div class="mday empty"></div>`;
  for(let d=1;d<=dim;d++){
    const tr=trainedDays.has(d), today=d===tod?' today':'';
    const oc=tr?`onclick="openSession(${d})"`:''
    inner+=`<div class="mday ${tr?'trained':'rest'}${today}" ${oc}>${d}</div>`;
  }

  // Projection: find latest weight per basic exercise
  const BASICS = [
    {label:'Sentadilla', match:'sentadilla'},
    {label:'Peso Muerto', match:'peso muerto'},
    {label:'Press Banca', match:'press banca'},
    {label:'Press Militar', match:'press militar'},
    {label:'Remo', match:'remo'},
  ];
  const maxW = {};
  sessions.forEach(s => {
    const ex = s.ejercicio.toLowerCase();
    BASICS.forEach(b => { if(ex.includes(b.match) && s.peso>0) maxW[b.label]=Math.max(maxW[b.label]||0,s.peso); });
  });
  let projRows = '';
  BASICS.forEach(b => {
    if(!maxW[b.label]) return;
    const c=maxW[b.label];
    projRows+=`<tr>
      <td class="ecol">${b.label}</td>
      <td>${c}</td>
      <td>${round25(c*1.025)}</td>
      <td>${round25(c*Math.pow(1.025,3))}</td>
      <td class="hl">${round25(c*Math.pow(1.025,12))}</td>
    </tr>`;
  });

  el.innerHTML = `
    <div class="slabel">${MONTHS[mo]} ${yr}</div>
    <div class="card">
      <div class="ch">
        <span class="ct">ğŸ“… Sesiones del mes</span>
        <span class="badge" style="background:rgba(255,95,31,.12);color:var(--fire)">${trainedDays.size} dÃ­as</span>
      </div>
      <div class="mgrid">
        ${cells}
        <div style="grid-column:1/-1;display:grid;grid-template-columns:repeat(7,1fr);gap:3px">${inner}</div>
      </div>
    </div>

    ${projRows?`
    <div class="slabel">ProyecciÃ³n sobrecarga progresiva</div>
    <div class="card">
      <div class="ch">
        <span class="ct">ğŸ“ˆ +2.5% por semana</span>
        <span class="badge" style="background:rgba(0,229,176,.1);color:var(--teal)">3 meses</span>
      </div>
      <table class="ptable">
        <tr><th class="ecol" style="text-align:left">Ejercicio</th><th>Actual</th><th>+2 sem</th><th>+4 sem</th><th>3 meses</th></tr>
        ${projRows}
      </table>
    </div>`:''}

    <div class="notice">ğŸ’¡ Toca un dÃ­a naranja para ver los ejercicios de esa sesiÃ³n. Actualiza el Sheet â†’ pulsa <strong>Sincronizar</strong>.</div>
  `;
}

function openSession(day) {
  const now=new Date(), yr=now.getFullYear(), mo=now.getMonth();
  const byDate = window._sessions||{};
  // Find session for this day (any format)
  let found = null;
  Object.keys(byDate).forEach(f => {
    const d = parseDate(f);
    if (d && d.getFullYear()===yr && d.getMonth()===mo && d.getDate()===day) found=byDate[f];
  });
  if (!found) return;
  const maxKg = Math.max(...found.map(s=>s.peso));
  document.getElementById('mDate').textContent = fmtFull(found[0].fecha);
  document.getElementById('mSub').textContent = `${found.length} ejercicios${maxKg>0?' Â· '+maxKg+' kg mÃ¡ximo':''}`;
  document.getElementById('mContent').innerHTML = found.map(s=>`
    <div class="exrow">
      <div>
        <div class="exname">${s.ejercicio}</div>
        <div class="excat">${s.categoria}</div>
      </div>
      <div class="exr">
        <div class="exkg">${s.peso>0?s.peso+' kg':'Peso Corp.'}</div>
        <div class="exdet">${s.series||'?'} Ã— ${s.reps||'?'}</div>
      </div>
    </div>`).join('');
  document.getElementById('sessionModal').classList.add('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HABITS
   Sheet structure:
     Row 1: Title
     Row 2: Empty
     Row 3: Section header "CONFIGURACIÃ“N"
     Row 4: Headers â†’ B=HÃ¡bito, C=Fecha Inicio, D=DÃ­as Racha, E=Estado
     Rows 5-12: Habit data
     Row 13+: Calendar (SKIP)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseHabits(rawRows) {
  const habits = [];
  // Data starts at index 4 (row 5), stop at blank or calendar section
  for (let i = 4; i < rawRows.length; i++) {
    const row = rawRows[i];
    const nombre = row[1]; // col B
    const fecha  = row[2]; // col C
    if (!nombre || !nombre.trim()) continue;
    // Stop at calendar section or blank rows after data
    const cn = clean(nombre);
    if (cn.includes('calendario') || cn.includes('lun') || cn.includes('mar')) break;
    habits.push({
      nombre: nombre.trim(),
      fechaInicio: fecha?fecha.trim():'',
    });
  }
  return habits;
}

const HAB_EMOJIS = {
  'alcohol':'ğŸº','golosina':'ğŸ¬','azucar':'ğŸ¥¤','azÃºcar':'ğŸ¥¤',
  'energetica':'âš¡','energÃ©tica':'âš¡','ayuno':'â±','agua':'ğŸ’§',
  'sueno':'ğŸ˜´','sueÃ±o':'ğŸ˜´','meditaci':'ğŸ§˜','default':'ğŸ¯'
};
function habitEmoji(name) {
  const n = name.toLowerCase();
  for(const [k,v] of Object.entries(HAB_EMOJIS)) if(n.includes(k)) return v;
  return 'ğŸ¯';
}
const HAB_COLORS = ['var(--fire)','var(--teal)','var(--gold)','var(--violet)','#2ECC71','#00BFFF','#FF69B4','#FFA500'];

function renderHabits() {
  const el  = document.getElementById('h-content');
  const raw = C.habits?.rows || [];

  if (!raw.length) {
    el.innerHTML = `<div class="state-box"><div class="spinner"></div><div class="state-title">Sin datos</div></div>`;
    return;
  }

  const habits = parseHabits(raw);

  let habitHTML = '';
  habits.forEach((h, i) => {
    const days  = calcDays(h.fechaInicio);
    const pct   = Math.min(100, (days/90)*100);
    const color = HAB_COLORS[i%HAB_COLORS.length];
    const emoji = habitEmoji(h.nombre);
    const medal = days>=90?'ğŸ†':days>=30?'ğŸ”¥':days>=14?'âœ…':days>=7?'ğŸŸ¡':'ğŸ”´';
    habitHTML += `<div class="hrow">
      <div class="hico">${emoji}</div>
      <div class="hinfo">
        <div class="hname">${h.nombre}</div>
        <div class="hmeta">${h.fechaInicio ? 'Desde '+h.fechaInicio : 'Sin fecha'}</div>
        <div class="hbar"><div class="hbar-fill" style="width:${pct}%;background:${color}"></div></div>
      </div>
      <div>
        <div class="hnum" style="color:${color}">${days}</div>
        <div class="hunit">dÃ­as ${medal}</div>
      </div>
    </div>`;
  });

  // Training calendar from training cache
  const now=new Date(), yr=now.getFullYear(), mo=now.getMonth();
  const trainedDays = new Set();
  (C.training?.rows||[]).slice(3).forEach(row => {
    const d = parseDate(row[1]);
    if (d && d.getFullYear()===yr && d.getMonth()===mo) trainedDays.add(d.getDate());
  });
  const off=weekOffset(yr,mo), dim=daysInMonth(yr,mo);
  const calLbls = DAYS7.map(d=>`<div class="cmlbl">${d}</div>`).join('');
  let calInner='';
  for(let i=0;i<off;i++) calInner+=`<div class="cmday e"></div>`;
  for(let d=1;d<=dim;d++) calInner+=`<div class="cmday ${trainedDays.has(d)?'t':'r'}">${d}</div>`;

  el.innerHTML = `
    <div class="slabel">Rachas activas</div>
    <div class="card">${habitHTML||'<div class="empty">Agrega hÃ¡bitos en el Google Sheet</div>'}</div>

    <div class="slabel">Calendario de entrenamiento â€” ${MONTHS[mo]}</div>
    <div class="card">
      <div class="ch">
        <span class="ct">ğŸ“… ${MONTHS[mo]} ${yr}</span>
        <span class="badge" style="background:rgba(0,229,176,.1);color:var(--teal)">${trainedDays.size} dÃ­as âœ…</span>
      </div>
      <div class="cmini">
        ${calLbls}
        <div style="grid-column:1/-1;display:grid;grid-template-columns:repeat(7,1fr);gap:3px">${calInner}</div>
      </div>
    </div>
  `;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MIND / INTELECTUAL
   Sheet structure:
     Row 1: Title
     Row 2: Empty
     Row 3: Section header "LIBROS"
     Row 4: Headers â†’ B=TÃ­tulo, C=Autor, D=Inicio, E=Fin, F=Estado, G=CategorÃ­a, H=Rating
     Rows 5-9: Book data
     Row 10: Total LeÃ­dos (skip)
     Row 11: Empty
     Row 12: Section header "TEMAS EN APRENDIZAJE"
     Row 13: Headers â†’ B=Tema, C=Fuente, D=Formato, E=Inicio, F=% Avance, G=Horas Dedicadas, H=Notas
     Rows 14+: Topic data
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseMind(rawRows) {
  const books=[], topics=[];
  let section='books';
  for(let i=3; i<rawRows.length; i++){
    const row=rawRows[i];
    const b1=clean(row[1]||''), b2=clean(row[2]||'');
    // Detect section transitions by row[1] content
    if(b1.includes('temas en aprendizaje')||b1.includes('tema en aprendizaje')) { section='topics'; continue; }
    if(b1.includes('total le')) continue; // skip totals row
    if(b1==='' && b2==='') continue; // skip blank rows
    // Skip header rows
    if(b1==='tÃ­tulo'||b1==='titulo'||b1==='tema') continue;

    if(section==='books') {
      const titulo = row[1]?.trim();
      if(!titulo) continue;
      books.push({
        titulo,
        autor:     row[2]?.trim()||'',
        inicio:    row[3]?.trim()||'',
        fin:       row[4]?.trim()||'',
        estado:    row[5]?.trim()||'',
        categoria: row[6]?.trim()||'',
        rating:    parseInt(row[7])||0,
      });
    } else {
      const tema = row[1]?.trim();
      if(!tema) continue;
      topics.push({
        tema,
        fuente:  row[2]?.trim()||'',
        formato: row[3]?.trim()||'',
        inicio:  row[4]?.trim()||'',
        avance:  parseInt((row[5]||'0').replace('%',''))||0,
        horas:   parseInt(row[6])||0,
        notas:   row[7]?.trim()||'',
      });
    }
  }
  return {books, topics};
}

const BCOLS=[['rgba(155,138,255,.2)','var(--violet)'],['rgba(0,229,176,.15)','var(--teal)'],['rgba(255,95,31,.15)','var(--fire)'],['rgba(246,201,14,.15)','var(--gold)']];
const TCOLS=['var(--teal)','var(--fire)','var(--violet)','var(--gold)'];

function renderMind() {
  const el  = document.getElementById('m-content');
  const raw = C.mind?.rows||[];

  if(!raw.length){
    el.innerHTML=`<div class="state-box"><div class="spinner"></div><div class="state-title">Sin datos</div></div>`;
    return;
  }

  const {books,topics}=parseMind(raw);
  const read=books.filter(b=>{
    const e=b.estado.toLowerCase();
    return e.includes('leido')||e.includes('le_do')||e.includes('le\u00Ã­do')||b.estado.includes('âœ…');
  }).length;

  let bookHTML='';
  books.forEach((b,i)=>{
    const [bg,fg]=BCOLS[i%4];
    const done=b.estado.includes('âœ…')||b.estado.toLowerCase().includes('le');
    const reading=b.estado.includes('ğŸ“–')||b.estado.toLowerCase().includes('leyendo');
    const sc=done?'rgba(46,204,113,.2)':reading?'rgba(246,201,14,.2)':'rgba(120,120,120,.15)';
    const st=done?'#2ECC71':reading?'#F6C90E':'var(--muted)';
    const stars=b.rating>0?'â­'.repeat(Math.min(b.rating,5)):'';
    bookHTML+=`<div class="brow">
      <div class="bcover" style="background:${bg};color:${fg}">ğŸ“—</div>
      <div class="binfo">
        <div class="btitle">${b.titulo}</div>
        <div class="bauthor">${[b.autor,b.categoria].filter(Boolean).join(' Â· ')||'â€”'}</div>
        <span class="bstatus" style="background:${sc};color:${st}">${b.estado||'â€”'}</span>
        ${stars?`<div class="brating">${stars}</div>`:''}
      </div>
    </div>`;
  });

  let topicHTML='';
  topics.forEach((t,i)=>{
    const c=TCOLS[i%4];
    const pct=Math.min(100,Math.max(0,t.avance));
    topicHTML+=`<div class="trow">
      <div class="tth">
        <div class="tname">${t.tema}</div>
        <div class="tpct" style="color:${c}">${t.avance==='Continuo'?'âˆ':t.avance+'%'}</div>
      </div>
      <div class="tmeta">${[t.fuente,t.formato,t.horas?t.horas+'h':''].filter(Boolean).join(' Â· ')}</div>
      <div class="tbar"><div class="tbar-fill" style="width:${pct}%;background:${c}"></div></div>
    </div>`;
  });

  el.innerHTML=`
    <div class="sgrid">
      <div class="scell"><div class="snum" style="color:var(--violet)">${read}</div><div class="slbl2">Libros leÃ­dos</div></div>
      <div class="scell"><div class="snum" style="color:var(--teal)">${topics.length}</div><div class="slbl2">Temas activos</div></div>
    </div>
    <div class="slabel">Biblioteca</div>
    <div class="card">${bookHTML||'<div class="empty">Agrega libros en la hoja Intelectual</div>'}</div>
    ${topicHTML?`<div class="slabel">Aprendizaje activo</div><div class="card">${topicHTML}</div>`:''}
  `;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOCIAL
   Sheet structure (from screenshot):
     Rows 1-8: CumpleaÃ±os section
       Row ~4: Headers â†’ B=Nombre, C=RelaciÃ³n, D=Fecha CumpleaÃ±os, E=DÃ­as Restantes / Regalo
       Rows 5-9: Birthday data
     Row 12: Section header "RED DE CONTACTOS"
     Row 13: Headers â†’ B=Nombre, C=ProfesiÃ³n/Rol, D=CÃ³mo lo conocÃ­, E=Fecha, F=Intereses Comunes, G=Ãšltimo Contacto, H=AcciÃ³n Siguiente
     Rows 14-18: Contact data
     Row 21: Section header "TRACKER EXPOSICIÃ“N SOCIAL MENSUAL"
     Row 22: Headers â†’ B=Fecha, C=Actividad, D=Personas, E=Incomodidad(1-5), F=Logro, G=ReflexiÃ³n
     Rows 23+: Exposure data
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseSocial(rawRows) {
  const bdays=[], contacts=[], exposures=[];
  // Birthdays: rows 4-8 (index 3-7), col B=Nombre, C=RelaciÃ³n, D=Fecha, E=Regalo/info
  for(let i=3;i<=8&&i<rawRows.length;i++){
    const row=rawRows[i];
    const nombre=(row[1]||'').trim();
    if(!nombre||clean(nombre)==='nombre') continue;
    bdays.push({ nombre, relacion:(row[2]||'').trim(), fecha:(row[3]||'').trim(), regalo:(row[4]||'').trim() });
  }
  // Contacts: rows 13-17 (index 12-16) â€” headers at index 12, data 13-17
  for(let i=13;i<=18&&i<rawRows.length;i++){
    const row=rawRows[i];
    const nombre=(row[1]||'').trim();
    if(!nombre) continue;
    contacts.push({ nombre, rol:(row[2]||'').trim(), como:(row[3]||'').trim(), fecha:(row[4]||'').trim(), intereses:(row[5]||'').trim(), ultimoContacto:(row[6]||'').trim(), accion:(row[7]||'').trim() });
  }
  // Exposures: rows 22+ (index 22+)
  for(let i=22;i<rawRows.length;i++){
    const row=rawRows[i];
    const fecha=(row[1]||'').trim(), act=(row[2]||'').trim();
    if(!act) continue;
    exposures.push({ fecha, actividad:act, personas:(row[3]||'').trim(), incomodidad:parseInt(row[4])||1, logro:(row[5]||'').trim(), reflexion:(row[6]||'').trim() });
  }
  return {bdays, contacts, exposures};
}

const BD_BG=['rgba(246,201,14,.18)','rgba(255,95,31,.15)','rgba(155,138,255,.15)','rgba(0,229,176,.12)'];
const CR_EMO=['ğŸ‘¤','ğŸ§‘â€ğŸ’¼','ğŸ‘©â€ğŸ’»','ğŸ‘¨â€ğŸ¨','ğŸ§‘â€ğŸ”¬','ğŸ‘©â€ğŸ«','ğŸ§‘â€ğŸš€','ğŸ‘¨â€ğŸ³'];

function renderSocial() {
  const el  = document.getElementById('s-content');
  const raw = C.social?.rows||[];

  if(!raw.length){
    el.innerHTML=`<div class="state-box"><div class="spinner"></div><div class="state-title">Sin datos</div></div>`;
    return;
  }

  const {bdays,contacts,exposures}=parseSocial(raw);

  let bdHTML='';
  bdays.filter(b=>b.nombre&&!clean(b.nombre).includes('pareja')||b.fecha&&b.fecha!=='DD/MM').forEach((b,i)=>{
    bdHTML+=`<div class="bdrow">
      <div class="bdav" style="background:${BD_BG[i%4]}">ğŸ‚</div>
      <div style="flex:1">
        <div class="bdname">${b.nombre}</div>
        <div class="bdrel">${b.relacion||'â€”'}</div>
        ${b.regalo?`<div style="font-size:10px;color:var(--muted);margin-top:2px">ğŸ ${b.regalo}</div>`:''}
      </div>
      <div style="text-align:right">
        <div class="bddate">${b.fecha||'â€”'}</div>
      </div>
    </div>`;
  });

  let ctHTML='';
  contacts.filter(c=>c.nombre).forEach((c,i)=>{
    ctHTML+=`<div class="crow">
      <div class="crh">
        <div class="crav">${CR_EMO[i%8]}</div>
        <div><div class="crname">${c.nombre}</div><div class="crrole">${c.rol||'â€”'}</div></div>
      </div>
      <div class="tags">
        ${c.como?`<span class="tag">ğŸ“ ${c.como}</span>`:''}
        ${c.intereses?`<span class="tag">ğŸ’¡ ${c.intereses}</span>`:''}
        ${c.accion?`<span class="tag">â†’ ${c.accion}</span>`:''}
      </div>
    </div>`;
  });

  let expHTML='';
  [...exposures].filter(e=>e.actividad).reverse().forEach(e=>{
    const d=e.incomodidad, cc=d>=4?'var(--fire)':d>=3?'var(--gold)':'var(--teal)';
    expHTML+=`<div class="exprow">
      <div class="expdot" style="background:${cc}"></div>
      <div>
        <div class="expact">${e.actividad}</div>
        <div class="expmeta">${[e.fecha,e.personas].filter(Boolean).join(' Â· ')}</div>
        <div class="disc">${'ğŸ”¥'.repeat(d)}${'â¬›'.repeat(5-d)}</div>
        ${e.reflexion?`<div class="expnote">"${e.reflexion}"</div>`:''}
      </div>
    </div>`;
  });

  el.innerHTML=`
    <div class="sgrid">
      <div class="scell"><div class="snum" style="color:var(--gold)">${contacts.filter(c=>c.nombre).length}</div><div class="slbl2">Contactos</div></div>
      <div class="scell"><div class="snum" style="color:var(--fire)">${exposures.filter(e=>e.actividad).length}</div><div class="slbl2">Exposiciones</div></div>
    </div>
    ${bdHTML?`<div class="slabel">CumpleaÃ±os</div><div class="card">${bdHTML}</div>`:''}
    ${ctHTML?`<div class="slabel">Red de contactos</div><div class="card">${ctHTML}</div>`:'<div class="slabel">Red de contactos</div><div class="card"><div class="empty">Agrega contactos en la hoja Social</div></div>'}
    ${expHTML?`<div class="slabel">ExposiciÃ³n social</div><div class="card">${expHTML}</div>`:'<div class="slabel">ExposiciÃ³n social</div><div class="card"><div class="empty">Registra interacciones en la hoja Social</div></div>'}
  `;
}

/* â”€â”€â”€ RENDER ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function safeRender(fn,elId){try{fn()}catch(e){console.error(elId,e);const el=document.getElementById(elId);if(el)el.innerHTML=`<div class="state-box"><div style="font-size:28px">âš ï¸</div><div class="state-title">Error al mostrar</div><div class="state-sub">${e.message}</div></div>`;}}
function renderAll(){safeRender(renderTraining,"t-content");safeRender(renderHabits,"h-content");safeRender(renderMind,"m-content");safeRender(renderSocial,"s-content");}

/* â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function(){
  const now=new Date();
  document.getElementById('hDate').textContent =
    now.toLocaleDateString('es-CL',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).toUpperCase();

  document.querySelectorAll('.overlay').forEach(m =>
    m.addEventListener('click', e => { if(e.target===m) m.classList.remove('open'); })
  );

  // Render from cache immediately (instant load)
  try { renderAll(); } catch(e) { console.error('init render:', e); }

  // Always sync on load to get fresh data
  syncAll();
})();
</script>
</body>
</html>
